#!/usr/bin/env bash
# realm2canvas - Convert adventure-engine realm definitions to boxes-live canvas
#
# Usage: realm2canvas <realm-file> [output-file]
#
# Realm File Format (JSON):
# {
#   "realm": "Whispering Woods",
#   "entities": [
#     {"id": "hero1", "name": "Aria", "type": "hero", "x": 10, "y": 20, "hp": 85, "max_hp": 100},
#     {"id": "npc1", "name": "Merchant", "type": "npc", "x": 30, "y": 15}
#   ],
#   "locations": [
#     {"name": "Ancient Temple", "x": 80, "y": 10, "description": "A crumbling temple"},
#     {"name": "Dark Caverns", "x": 40, "y": 60, "description": "Mysterious caves"}
#   ],
#   "events": [
#     {"type": "quest", "title": "Find the Lost Artifact", "status": "active"}
#   ]
# }

set -e

# Default values
INPUT_FILE="${1:-realm.json}"
OUTPUT_FILE="${2:-realm_canvas.txt}"

# Check if jq is available (for JSON parsing)
if ! command -v jq &> /dev/null; then
    echo "Warning: jq not found. Using simplified JSON parsing." >&2
    USE_SIMPLE_PARSER=1
else
    USE_SIMPLE_PARSER=0
fi

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Realm file '$INPUT_FILE' not found" >&2
    echo "Creating example realm file..." >&2

    # Create example realm file
    cat > "$INPUT_FILE" << 'EOF'
{
  "realm": "The Whispering Woods",
  "description": "A mystical forest shrouded in ancient magic",
  "dimensions": {"width": 200, "height": 150},
  "entities": [
    {
      "id": "hero1",
      "name": "Aria the Warrior",
      "type": "hero",
      "class": "warrior",
      "x": 20,
      "y": 25,
      "hp": 85,
      "max_hp": 100,
      "level": 5,
      "status": "ready"
    },
    {
      "id": "hero2",
      "name": "Thorne the Rogue",
      "type": "hero",
      "class": "rogue",
      "x": 25,
      "y": 25,
      "hp": 60,
      "max_hp": 70,
      "level": 4,
      "status": "wounded"
    },
    {
      "id": "npc1",
      "name": "Elder Sage",
      "type": "npc",
      "x": 70,
      "y": 15,
      "role": "quest_giver",
      "dialogue": "Seek the ancient artifact in the temple..."
    },
    {
      "id": "enemy1",
      "name": "Shadow Beast",
      "type": "enemy",
      "x": 45,
      "y": 65,
      "hp": 120,
      "max_hp": 120,
      "threat_level": "high"
    }
  ],
  "locations": [
    {
      "id": "loc1",
      "name": "Ancient Temple",
      "x": 85,
      "y": 15,
      "type": "dungeon",
      "description": "A crumbling temple filled with ancient magic",
      "explored": false
    },
    {
      "id": "loc2",
      "name": "Village of Thornhaven",
      "x": 15,
      "y": 85,
      "type": "settlement",
      "description": "A peaceful village under threat",
      "population": 200
    },
    {
      "id": "loc3",
      "name": "Dark Caverns",
      "x": 45,
      "y": 75,
      "type": "dungeon",
      "description": "Mysterious caves echoing with strange sounds",
      "explored": true
    }
  ],
  "quests": [
    {
      "id": "quest1",
      "title": "Find the Lost Artifact",
      "status": "active",
      "description": "Retrieve the Moonstone from the Ancient Temple",
      "reward": "1000 gold, +2 magic staff"
    },
    {
      "id": "quest2",
      "title": "Rescue the Villagers",
      "status": "active",
      "description": "Save villagers captured by the Shadow Beasts",
      "reward": "500 gold, village gratitude"
    }
  ],
  "state": {
    "day": 3,
    "time": "evening",
    "weather": "light rain",
    "mood": "tense"
  }
}
EOF
    echo "Created example realm: $INPUT_FILE" >&2
fi

# Simple JSON parser (fallback when jq not available)
simple_json_get() {
    local json="$1"
    local key="$2"
    echo "$json" | grep -o "\"$key\"[^,}]*" | head -1 | sed 's/.*: *"\?\([^,"]*\)"\?.*/\1/'
}

# Parse realm and generate canvas
{
    # Read JSON
    REALM_JSON=$(cat "$INPUT_FILE")

    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        # Use jq for robust parsing
        REALM_NAME=$(echo "$REALM_JSON" | jq -r '.realm // "Unknown Realm"')
        REALM_DESC=$(echo "$REALM_JSON" | jq -r '.description // ""')
        WIDTH=$(echo "$REALM_JSON" | jq -r '.dimensions.width // 200')
        HEIGHT=$(echo "$REALM_JSON" | jq -r '.dimensions.height // 150')
    else
        # Fallback to simple parsing
        REALM_NAME=$(simple_json_get "$REALM_JSON" "realm")
        REALM_DESC=$(simple_json_get "$REALM_JSON" "description")
        WIDTH=200
        HEIGHT=150
    fi

    # Canvas header
    echo "# Realm Canvas: $REALM_NAME"
    echo "# Generated by realm2canvas from $INPUT_FILE"
    echo "# Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    echo "WIDTH: $WIDTH"
    echo "HEIGHT: $HEIGHT"
    echo ""

    # Realm overview box
    echo "BOX: 5.0 5.0 45.0 10.0"
    echo "TITLE: $REALM_NAME"
    echo "CONTENT:"
    echo "$REALM_DESC"
    echo ""

    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        # Parse state
        DAY=$(echo "$REALM_JSON" | jq -r '.state.day // 1')
        TIME=$(echo "$REALM_JSON" | jq -r '.state.time // "day"')
        WEATHER=$(echo "$REALM_JSON" | jq -r '.state.weather // "clear"')
        MOOD=$(echo "$REALM_JSON" | jq -r '.state.mood // "calm"')

        echo "Day: $DAY | Time: $TIME"
        echo "Weather: $WEATHER | Mood: $MOOD"
    else
        echo "Adventure in progress..."
    fi
    echo "END"
    echo ""

    # Heroes box
    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        HERO_COUNT=$(echo "$REALM_JSON" | jq '[.entities[] | select(.type == "hero")] | length')
        if [ "$HERO_COUNT" -gt 0 ]; then
            echo "BOX: 5.0 20.0 35.0 $(( 8 + HERO_COUNT * 2 ))"
            echo "TITLE: Party (Heroes)"
            echo "CONTENT:"

            echo "$REALM_JSON" | jq -r '.entities[] | select(.type == "hero") |
                "\(.name) (L\(.level // 1))\n  HP: \(.hp // 0)/\(.max_hp // 100) | Status: \(.status // "unknown")"'

            echo "END"
            echo ""
        fi
    fi

    # Locations
    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        echo "$REALM_JSON" | jq -c '.locations[]?' 2>/dev/null | while IFS= read -r location; do
            LOC_NAME=$(echo "$location" | jq -r '.name')
            LOC_X=$(echo "$location" | jq -r '.x')
            LOC_Y=$(echo "$location" | jq -r '.y')
            LOC_TYPE=$(echo "$location" | jq -r '.type // "location"')
            LOC_DESC=$(echo "$location" | jq -r '.description // ""')
            LOC_EXPLORED=$(echo "$location" | jq -r '.explored // false')

            # Visual indicator for type
            case "$LOC_TYPE" in
                dungeon) ICON="âš”" ;;
                settlement) ICON="ðŸ›" ;;
                *) ICON="ðŸ“" ;;
            esac

            echo "BOX: $LOC_X $LOC_Y 30.0 8.0"
            echo "TITLE: $ICON $LOC_NAME"
            echo "CONTENT:"
            echo "$LOC_DESC"
            echo ""
            echo "Type: $LOC_TYPE"
            [ "$LOC_EXPLORED" = "true" ] && echo "Status: Explored" || echo "Status: Unexplored"
            echo "END"
            echo ""
        done
    fi

    # Entities (NPCs and enemies)
    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        echo "$REALM_JSON" | jq -c '.entities[] | select(.type != "hero")?' 2>/dev/null | while IFS= read -r entity; do
            ENT_NAME=$(echo "$entity" | jq -r '.name')
            ENT_X=$(echo "$entity" | jq -r '.x')
            ENT_Y=$(echo "$entity" | jq -r '.y')
            ENT_TYPE=$(echo "$entity" | jq -r '.type')
            ENT_HP=$(echo "$entity" | jq -r '.hp // "N/A"')
            ENT_MAX_HP=$(echo "$entity" | jq -r '.max_hp // "N/A"')

            # Color coding by type
            case "$ENT_TYPE" in
                enemy) COLOR="red" ;;
                npc) COLOR="green" ;;
                *) COLOR="white" ;;
            esac

            echo "BOX: $ENT_X $ENT_Y 25.0 7.0"
            echo "TITLE: $ENT_NAME"
            echo "COLOR: $COLOR"
            echo "CONTENT:"
            echo "Type: $ENT_TYPE"

            if [ "$ENT_HP" != "N/A" ]; then
                echo "HP: $ENT_HP/$ENT_MAX_HP"
            fi

            # Additional fields
            if [ "$ENT_TYPE" = "npc" ]; then
                ROLE=$(echo "$entity" | jq -r '.role // ""')
                [ -n "$ROLE" ] && echo "Role: $ROLE"
            elif [ "$ENT_TYPE" = "enemy" ]; then
                THREAT=$(echo "$entity" | jq -r '.threat_level // "medium"')
                echo "Threat: $THREAT"
            fi

            echo "END"
            echo ""
        done
    fi

    # Quests box
    if [ $USE_SIMPLE_PARSER -eq 0 ]; then
        QUEST_COUNT=$(echo "$REALM_JSON" | jq '[.quests[]?] | length' 2>/dev/null || echo 0)
        if [ "$QUEST_COUNT" -gt 0 ]; then
            echo "BOX: 55.0 5.0 40.0 $(( 8 + QUEST_COUNT * 3 ))"
            echo "TITLE: Quest Log"
            echo "CONTENT:"

            echo "$REALM_JSON" | jq -r '.quests[]? |
                "[\(.status | ascii_upcase)] \(.title)\n  \(.description // "")"'

            echo "END"
            echo ""
        fi
    fi

} > "$OUTPUT_FILE"

echo "âœ“ Realm canvas generated: $OUTPUT_FILE" >&2
echo "  Realm: $REALM_NAME" >&2
echo "  Dimensions: ${WIDTH}x${HEIGHT}" >&2

if [ $USE_SIMPLE_PARSER -eq 1 ]; then
    echo "" >&2
    echo "Note: Install 'jq' for full realm parsing" >&2
    echo "  sudo apt-get install jq" >&2
fi

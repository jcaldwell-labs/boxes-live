#!/usr/bin/env python3
"""
git2canvas - Visualize git commit history on canvas

Usage:
    cd /path/to/repo
    git2canvas > commits.txt
    git2canvas --max 20 --branch main > commits.txt

Options:
    --max N        Show last N commits (default: 50)
    --branch B     Specific branch (default: current)
    --author A     Filter by author
    --since DATE   Commits since date
"""

import subprocess
import sys
import argparse

def parse_args():
    parser = argparse.ArgumentParser(description='Visualize git history')
    parser.add_argument('--max', type=int, default=50, help='Max commits to show')
    parser.add_argument('--branch', help='Specific branch')
    parser.add_argument('--author', help='Filter by author')
    parser.add_argument('--since', help='Commits since date')
    return parser.parse_args()

def get_commits(args):
    """Fetch git commits"""
    cmd = ['git', 'log', '--pretty=format:%H|%an|%ar|%s']

    if args.branch:
        cmd.append(args.branch)

    if args.author:
        cmd.extend(['--author', args.author])

    if args.since:
        cmd.extend(['--since', args.since])

    cmd.extend(['-n', str(args.max)])

    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return result.stdout.strip().split('\n')
    except subprocess.CalledProcessError:
        print("Error: Not in a git repository or git command failed", file=sys.stderr)
        sys.exit(1)

def generate_canvas(commits):
    """Generate canvas from commits"""
    if not commits or not commits[0]:
        print("Error: No commits found", file=sys.stderr)
        sys.exit(1)

    # Canvas header
    print("BOXES_CANVAS_V1")

    world_width = len(commits) * 180 + 200
    print(f"{world_width} 1000.0")
    print(len(commits))

    # Author color mapping (deterministic)
    author_colors = {}

    x, y = 100, 100

    for box_id, commit in enumerate(commits, 1):
        parts = commit.split('|', 3)
        if len(parts) < 4:
            continue

        hash_full, author, date, message = parts

        # Assign color to author
        if author not in author_colors:
            author_colors[author] = (len(author_colors) % 7) + 1

        color = author_colors[author]

        # Truncate for display
        short_hash = hash_full[:7]
        short_message = message[:40]

        # Output box
        print(f"{box_id} {x} {y} 35 8 0 {color}")
        print(short_message)
        print("3")
        print(short_hash)
        print(author)
        print(date)

        # Horizontal timeline layout
        x += 180
        if x > world_width - 200:
            x = 100
            y += 120

def main():
    args = parse_args()
    commits = get_commits(args)
    generate_canvas(commits)

if __name__ == '__main__':
    main()
